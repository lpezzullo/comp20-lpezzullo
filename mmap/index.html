<!DOCTYPE html>
<html>
<head>
	<title>The Real Marauder's Map</title>
	<link rel="stylesheet" href="style.css" />
	<script src="http://maps.google.com/maps/api/js?sensor=true"></script>
		<script>

		// 1. Read in data
		// 2. Draw map, centered on me
		// 3. Drop markers for others
			var xhr;
			var data;
			var markers = [];
			var windows = [];
			var listeners = [];

			function init() {
				var myLat = 0;
				var myLng = 0;
				navigator.geolocation.getCurrentPosition(function(position) {
					console.log("2. Finally got your location!");
					myLat = position.coords.latitude;
					myLng = position.coords.longitude;
					xhr = new XMLHttpRequest();
					xhr.open("post", "https://secret-about-box.herokuapp.com/sendLocation", true);
					xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
					xhr.onreadystatechange = dataReady;
					xhr.send("login=RoyMcFatter&lat=" + myLat + "&lng=" + myLng);
					});
				
			}

			function dataReady() {
				console.log("Ready state changed to" + xhr.readyState);
				if (xhr.readyState == 4 && xhr.status == 200) {
					console.log("Got data!");
					data = JSON.parse(xhr.responseText);
					var landmark = new google.maps.LatLng(0,0);

					// For every user, make a marker & put it in the array.
					var j = 0;
					var myIndex = 0;

					for(var i in data) {	

						// Unless it's me!
						if (data[i].login=="RoyMcFatter") { 
							myIndex = i;
							continue;
						}

						console.log(data[i].login);
						landmark = new google.maps.LatLng(data[i].lat, data[i].lng);

						// Make a marker in the markers array...
						markers[i] = new google.maps.Marker({	
							position: landmark,
							title: data[i].login
						});
					}
					drawMap(data[myIndex].lat, data[myIndex].lng);
				}
				else if (xhr.readyState == 4 && xhr.status == 500) {
					console.log("Error 500");
				}
			}

			function drawMap(myLat, myLng)
			{
				console.log("Executing drawMap()");
				// My Location
				var landmark = new google.maps.LatLng(myLat,myLng);
			
				// Set up map
				var myOptions = {
					zoom: 13,
					center: landmark,
					mapTypeId: google.maps.MapTypeId.ROADMAP
				};
				
				// Create the map in the "map_canvas" <div>
				var map = new google.maps.Map(document.getElementById("map-canvas"), myOptions);

				// Drop my marker
				var birdIcon = new Image();
				birdIcon.src = "me2.jpg";
				birdIcon.addEventListener("load", function() {
					// Create a marker			
					var marker = new google.maps.Marker({
						position: landmark,
						title: "RoyMcFatter",
						icon: birdIcon.src
					});
					marker.setMap(map);

					// This is a global info window...
					var infowindow = new google.maps.InfoWindow();
	
					// Open info window on click of marker
					google.maps.event.addListener(marker, 'click', function() {
						infowindow.setContent(marker.title);
						infowindow.open(map, marker);
						});
				}, false);

				var distance = "";
				// Drop the other markers & give them info windows:
				for (var k in markers) {
					if (markers[k].title == "RoyMcFatter") {
						continue;
					}
					(function(k) {
						markers[k].setMap(map);

					//	distance = haversine(myLat, myLng, markers[k].getPosition());
						windows[k] = new google.maps.InfoWindow();

						google.maps.event.addListener(markers[k], 'click', function() {
							windows[k].setContent("<div>" + markers[k].title + "</div>");
								//<p>" + 
								//distance + "</p>");
							windows[k].open(map, markers[k]);
						});
					})(k);
				}	
			}
/*
			function haversine(myLat, myLng, theirPos) {
				var R = 6371000; // metres
				
				var lat1 = myLat;
				var lat2 = theirPos.lat();
				var lon1 = myLng;
				var lon2 = theirPos.lng();
				
				var myLat = lat1.toRadians();
				var theirLat = lat2.toRadians();
				var deltaPsi = (lat2-lat1).toRadians();
				var deltaGamma = (lon2-lon1).toRadians();

				var a = Math.sin(deltaPsi/2) * Math.sin(deltaPsi/2) +
				        Math.cos(lat1) * Math.cos(lat2) *
				        Math.sin(deltaGamma/2) * Math.sin(deltaGamma/2);
				var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

				var d = R * c;

				var metersPerMile = 1609.34;
				var inMiles = d/metersPerMile;
				inMiles = inMiles.toString() + " miles from you";

				return inMiles;
			}
*/
		</script>
	</head>
	<body onload = "init()">
		<div id = "map-canvas">Getting your location...</div>
	</body>
</html>